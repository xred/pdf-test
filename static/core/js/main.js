// Generated by CoffeeScript 1.6.3
(function() {
  var App, GlobalMouseListener, Page, RectMark, pdfUrl,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    _this = this;

  console.log("run");

  pdfUrl = null;

  GlobalMouseListener = (function(_super) {
    __extends(GlobalMouseListener, _super);

    function GlobalMouseListener() {
      GlobalMouseListener.__super__.constructor.apply(this, arguments);
      this.unbindEvents();
    }

    GlobalMouseListener.prototype.bindEvents = function() {
      var _this = this;
      document.body.onmousemove = function(evt) {
        return _this.emit("mousemove", evt);
      };
      document.body.onmouseup = function(evt) {
        return _this.emit("mouseup", evt);
      };
      return document.body.onmousedown = function(evt) {
        return _this.emit("mousedown", evt);
      };
    };

    GlobalMouseListener.prototype.unbindEvents = function() {
      document.body.onmousemove = null;
      document.body.onmouseup = null;
      return document.body.onmousedown = null;
    };

    GlobalMouseListener.prototype.on = function() {
      if (!document.body.onmousemove) {
        this.bindEvents();
      }
      return GlobalMouseListener.__super__.on.apply(this, arguments);
    };

    GlobalMouseListener.prototype.off = function() {
      GlobalMouseListener.__super__.off.apply(this, arguments);
      if (Object.keys(this._events).length === 0) {
        return this.unbindEvents();
      }
    };

    return GlobalMouseListener;

  })(Suzaku.EventEmitter);

  App = (function(_super) {
    var newCommentLock;

    __extends(App, _super);

    newCommentLock = false;

    function App() {
      var am, tm,
        _this = this;
      App.__super__.constructor.apply(this, arguments);
      this.marks = [];
      this.comments = [];
      this.aid = window.pdfDocument.fingerprint;
      am = new Suzaku.ApiManager;
      am.setPath("/pdfview/");
      am.setMethod("get");
      am.declare("getComments", "/comment", ["aid=" + this.aid]);
      am.setMethod("post");
      am.declare("addComment", "/comment", ["action=add", "aid=" + this.aid, "content", "markdata"]);
      am.declare("addCommentToMark", "/comment", ["action=add", "aid=" + this.aid, "content", "markid"]);
      am.declare("voteupComment", "/comment", ["action=voteup", "commentid"]);
      am.declare("votedownComment", "/comment", ["action=votedown", "commentid"]);
      this.api = am.generate();
      tm = new Suzaku.TemplateManager;
      tm.setPath("/core/templates/");
      tm.use("comments-item", "rect-mark", "single-comment-item");
      tm.start(function(tpls) {
        window.tpls = tpls;
        return _this.start();
      });
    }

    App.prototype.start = function() {
      var _this = this;
      return this.initComments(function() {
        var p, pages, _i, _len, _ref;
        _this.pages = [];
        _ref = pages = $(".page");
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          p = _ref[_i];
          _this.pages.push(new Page(_this, p));
        }
        _this.rightSection = new RightSection(_this);
        $("#newComment").on("click", function() {
          if (newCommentLock) {
            return false;
          }
          $("#newComment").addClass("toggled");
          $(".marking-wrapper").removeClass("hide");
          return _this.newComment();
        });
        $("#hideMarks").on("click", function() {
          return $(".marking-wrapper").toggleClass("hide");
        });
        return window.onresize = function() {
          var _j, _len1, _ref1, _results;
          _ref1 = _this.pages;
          _results = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            p = _ref1[_j];
            _results.push(p.onresize());
          }
          return _results;
        };
      });
    };

    App.prototype.initComments = function(callback) {
      var call,
        _this = this;
      call = this.api.getComments(function(res) {
        var c, m, _i, _j, _len, _len1, _ref, _ref1;
        if (res.success) {
          _this.comments = res.comments;
          _this.marks = res.marks;
          _ref = _this.marks;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            m = _ref[_i];
            m.comments = [];
            _ref1 = _this.comments;
            for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
              c = _ref1[_j];
              if (c.markid === m.markid) {
                m.comments.push(c);
              }
            }
          }
        }
        if (callback) {
          return callback();
        }
      });
      return call.fail(function() {
        return console.error("cannot get comments", arguments);
      });
    };

    App.prototype.newComment = function() {
      newCommentLock = true;
      $(".rectMark").removeClass("focus").addClass("unselectable");
      this.emit("newComment");
      return this.rightSection.showNewCommentHint();
    };

    App.prototype.newCommentConfirm = function(page) {
      var editPage, fail, success,
        _this = this;
      this.emit("newComment:confirm");
      page.newCommentConfirm();
      editPage = null;
      success = function(content) {
        console.log(content);
        editPage.off("useColor");
        if (content.replace(" ", "").length === "0") {
          alert("Error: Content is Empty");
        }
        return _this.newCommentSuccessed(page, content);
      };
      fail = function() {
        editPage.off("useColor");
        return _this.newCommentCanceled(page);
      };
      this.rightSection.hideNewCommentHint();
      editPage = this.rightSection.showEditPage("newComment", null, success, fail);
      return editPage.on("useColor", function(color) {
        page.tempRectMark.J.removeClass("color1 color2 color3 color4").addClass("color" + color);
        return page.tempRectMark.color = color;
      });
    };

    App.prototype.newCommentSuccessed = function(page, content) {
      var call, markData,
        _this = this;
      newCommentLock = false;
      markData = page.getTempMarkData();
      $("#newComment").removeClass("toggled");
      console.log("new comment page:", page, "content:", content);
      page.newCommentCompleted();
      $(".rectMark").removeClass("unselectable");
      return call = this.api.addComment(content, markData, function(res) {
        if (!res.success) {
          console.error(res.error_msg);
        }
        return _this.initComments(function() {
          _this.rightSection.initComments().resetStack().goInto(_this.rightSection.commentPage);
          return page.initMarks();
        });
      });
    };

    App.prototype.newCommentCanceled = function(page) {
      var p, _i, _len, _ref;
      newCommentLock = false;
      if (page) {
        page.newCommentCompleted();
      } else {
        _ref = this.pages;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          p = _ref[_i];
          p.newCommentCompleted();
        }
      }
      $("#newComment").removeClass("toggled");
      return $(".rectMark").removeClass("unselectable");
    };

    App.prototype.addCommentToMark = function(content, markData) {
      var call, markid,
        _this = this;
      markid = markData.markid;
      return call = this.api.addCommentToMark(content, markid, function(res) {
        if (!res.success) {
          console.error(res.error_msg);
        }
        return _this.initComments(function() {
          return _this.rightSection.initComments().resetStack().goInto(_this.rightSection.commentPage, function() {
            _this.rightSection.scrollToMarkComments(markid);
            return _this.scrollToRectMark(markData);
          });
        });
      });
    };

    App.prototype.getPageById = function(pageid) {
      var page, res, _i, _len, _ref;
      _ref = this.pages;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        page = _ref[_i];
        if (parseInt(pageid) === parseInt(page.pageid)) {
          res = page;
        }
      }
      return res;
    };

    App.prototype.scrollToRectMark = function(markData) {
      var markJ, page, targetTop,
        _this = this;
      $(".marking-wrapper").removeClass("hide");
      page = this.getPageById(markData.pageid);
      markJ = $("#mark-" + markData.markid);
      targetTop = page.dom.offsetTop + parseInt(markJ.css("top").replace("xp", "")) - 30;
      if (!markJ.hasClass("focus")) {
        $(".rectMark").removeClass("focus");
      }
      $("#viewerContainer").animate({
        scrollTop: targetTop
      }, "normal", "swing", function() {
        return markJ.addClass("focus");
      });
      return true;
    };

    return App;

  })(Suzaku.EventEmitter);

  RectMark = (function(_super) {
    __extends(RectMark, _super);

    function RectMark(type, pageSize, data) {
      if (type == null) {
        type = "normal";
      }
      RectMark.__super__.constructor.call(this, window.tpls['rect-mark']);
      if (type === "temp") {
        this.tempType();
      } else {
        this.data = data;
        this.id = data.markid;
        this.dom.id = "mark-" + this.id;
        this.J.addClass("color" + data.markcolor);
        this.J.css({
          color: data.markcolor
        });
        this.updateSize(pageSize);
      }
    }

    RectMark.prototype.updateSize = function(pageSize) {
      var a;
      a = 100;
      return this.J.css({
        left: this.data.markx * pageSize.width / a,
        top: this.data.marky * pageSize.height / a,
        width: this.data.markw * pageSize.width / a,
        height: this.data.markh * pageSize.height / a
      });
    };

    RectMark.prototype.tempType = function() {
      var _this = this;
      this.J.addClass("temp focus color1");
      this.color = 1;
      this.dom.onmousedown = function(evt) {
        return _this.emit("drag", evt.clientX, evt.clientY);
      };
      return this.UI['resizer'].onmousedown = function(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        return _this.emit("resize", evt.clientX, evt.clientY);
      };
    };

    RectMark.prototype.getData = function() {
      var obj;
      obj = {
        left: this.dom.offsetLeft,
        top: this.dom.offsetTop,
        width: this.dom.offsetWidth,
        height: this.dom.offsetHeight,
        color: this.color
      };
      return obj;
    };

    return RectMark;

  })(Suzaku.Widget);

  Page = (function(_super) {
    __extends(Page, _super);

    function Page(app, pageContainerDom) {
      var _this = this;
      Page.__super__.constructor.call(this, pageContainerDom);
      this.pageid = parseInt(this.dom.id.replace("pageContainer", ""));
      this.markingWrapper = new Suzaku.Widget("<div class='marking-wrapper'></div>");
      this.markingWrapper.appendTo(this.dom);
      this.textLayerJ = this.J.find('.textLayer');
      this.app = app;
      this.marks = [];
      this.initMarks();
      app.on("newComment", function() {
        return _this.newCommentActive();
      });
      app.on("newComment:confirm", function() {
        return _this.clearListeners();
      });
      app.on("newComment:active", function(page) {
        if (page !== _this) {
          return _this.clearListeners();
        }
      });
    }

    Page.prototype.onresize = function() {
      var m, pageSize, _i, _len, _ref, _results;
      this.J = $("body #" + this.dom.id);
      this.dom = this.J.get(0);
      this.markingWrapper.appendTo(this.dom);
      pageSize = this.getPageSize();
      _ref = this.marks;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        m = _ref[_i];
        _results.push(m.updateSize(pageSize));
      }
      return _results;
    };

    Page.prototype.getPageSize = function() {
      var obj;
      obj = {
        width: parseFloat(this.J.css("width").replace("px", "")),
        height: parseFloat(this.J.css("height").replace("px", ""))
      };
      return obj;
    };

    Page.prototype.clearListeners = function() {
      this.dom.onmouseup = null;
      this.dom.onmousedown = null;
      return this.dom.onmousemove = null;
    };

    Page.prototype.newCommentActive = function() {
      var _this = this;
      this.dom.onmousedown = function(evt) {
        var r, x, y;
        if (_this.tempRectMark) {
          return false;
        }
        _this.app.emit("newComment:active", _this);
        evt.preventDefault();
        _this.textLayerJ = _this.J.find('.textLayer');
        r = _this.textLayerJ[0].getBoundingClientRect();
        x = evt.clientX - r.left;
        y = evt.clientY - r.top;
        _this.mouseStartPos = {
          x: x,
          y: y
        };
        _this.tempRectMark = new RectMark("temp");
        _this.tempRectMark.J.css({
          left: x,
          top: y
        });
        return _this.tempRectMark.appendTo(_this.markingWrapper);
      };
      this.dom.onmouseup = function(evt) {
        if (!_this.mouseStartPos) {
          return false;
        }
        _this.mouseStartPos = null;
        _this.clearListeners();
        return _this.app.newCommentConfirm(_this);
      };
      return this.dom.onmousemove = function(evt) {
        var height, left, r, sp, top, width, x, y;
        if (!_this.mouseStartPos) {
          return false;
        }
        r = _this.textLayerJ[0].getBoundingClientRect();
        x = evt.clientX - r.left;
        y = evt.clientY - r.top;
        sp = _this.mouseStartPos;
        if (y < sp.y) {
          top = y;
        } else {
          top = sp.y;
        }
        if (x < sp.x) {
          left = x;
        } else {
          left = sp.x;
        }
        width = Math.abs(x - sp.x);
        height = Math.abs(y - sp.y);
        return _this.tempRectMark.J.css({
          left: left,
          top: top,
          width: width,
          height: height
        });
      };
    };

    Page.prototype.newCommentConfirm = function() {
      var action, defaultData,
        _this = this;
      action = "none";
      defaultData = this.tempRectMark.getData();
      this.tempRectMark.on("drag", function(x, y) {
        _this.mouseStartPos = {
          x: x,
          y: y
        };
        return action = "drag";
      });
      this.tempRectMark.on("resize", function(x, y) {
        _this.mouseStartPos = {
          x: x,
          y: y
        };
        return action = "resize";
      });
      window.globalMouseListener.on("mouseup", "newCommentConfirm", function(evt) {
        if (!_this.mouseStartPos) {
          return false;
        }
        action = "none";
        _this.mouseStartPos = null;
        return defaultData = _this.tempRectMark.getData();
      });
      return window.globalMouseListener.on("mousemove", "newCommentConfirm", function(evt) {
        var dx, dy, height, width;
        if (!_this.mouseStartPos) {
          return false;
        }
        dx = evt.clientX - _this.mouseStartPos.x;
        dy = evt.clientY - _this.mouseStartPos.y;
        switch (action) {
          case "drag":
            return _this.tempRectMark.J.css({
              left: defaultData.left + dx,
              top: defaultData.top + dy
            });
          case "resize":
            width = defaultData.width + dx;
            height = defaultData.height + dy;
            if (width < 5) {
              width = 5;
            }
            if (height < 5) {
              height = 5;
            }
            return _this.tempRectMark.J.css({
              width: width,
              height: height
            });
          default:
            return console.log("error status", action);
        }
      });
    };

    Page.prototype.getTempMarkData = function() {
      var a, data, obj, pageSize;
      data = this.tempRectMark.getData();
      pageSize = this.getPageSize();
      a = 100;
      obj = {
        x: data.left / pageSize.width * a,
        y: data.top / pageSize.height * a,
        w: data.width / pageSize.width * a,
        h: data.height / pageSize.height * a,
        pageid: this.pageid,
        color: data.color
      };
      return obj;
    };

    Page.prototype.newCommentCompleted = function() {
      if (!this.tempRectMark) {
        return false;
      }
      window.globalMouseListener.off("mouseup", "newCommentConfirm");
      window.globalMouseListener.off("mousemove", "newCommentConfirm");
      this.tempRectMark.remove();
      return this.tempRectMark = null;
    };

    Page.prototype.initMarks = function() {
      var m, pageSize, _i, _j, _len, _len1, _ref, _ref1;
      _ref = this.marks;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        m = _ref[_i];
        m.remove();
      }
      this.marks = [];
      pageSize = this.getPageSize();
      _ref1 = this.app.marks;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        m = _ref1[_j];
        if (m.pageid === this.pageid) {
          this.marks.push(this.addMark(pageSize, m));
        }
      }
      return true;
    };

    Page.prototype.addMark = function(pageSize, markData) {
      var item,
        _this = this;
      item = new RectMark("normal", pageSize, markData);
      item.markData = markData;
      item.appendTo(this.markingWrapper);
      item.dom.onclick = function() {
        $(".rectMark").removeClass("focus");
        item.J.addClass("focus");
        return _this.app.rightSection.scrollToMarkComments(markData.markid);
      };
      return item;
    };

    return Page;

  })(Suzaku.Widget);

  RunPDFViewer(pdfUrl, function() {
    var ckConfig;
    window.globalMouseListener = new GlobalMouseListener();
    new App();
    ckConfig = {
      height: 400
    };
    return CKEDITOR.replace("editPageEditor", ckConfig);
  });

}).call(this);
