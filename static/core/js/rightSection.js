// Generated by CoffeeScript 1.6.3
(function() {
  var CommentsItem, EditPage, RightSectionPage, SingleCommentPage, _ref, _ref1,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  RightSectionPage = (function(_super) {
    var animateRate;

    __extends(RightSectionPage, _super);

    function RightSectionPage() {
      _ref = RightSectionPage.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    animateRate = "normal";

    RightSectionPage.prototype.init = function() {
      return true;
    };

    RightSectionPage.prototype.enterFromRight = function() {
      this.emit("enter");
      this.J.css({
        left: "110%",
        display: "block"
      });
      return this.J.animate({
        left: "0"
      }, animateRate);
    };

    RightSectionPage.prototype.enterFromLeft = function() {
      this.emit("enter");
      this.J.css({
        left: "-110%",
        display: "block"
      });
      return this.J.animate({
        left: "0"
      }, animateRate);
    };

    RightSectionPage.prototype.leaveToLeft = function() {
      var _this = this;
      this.emit("leave");
      this.J.css({
        left: "0"
      });
      return this.J.animate({
        left: "-110%"
      }, animateRate, function() {
        return _this.J.hide();
      });
    };

    RightSectionPage.prototype.leaveToRight = function() {
      var _this = this;
      this.emit("leave");
      this.J.css({
        left: "0"
      });
      return this.J.animate({
        left: "110%"
      }, animateRate, function() {
        return _this.J.hide();
      });
    };

    return RightSectionPage;

  })(Suzaku.Widget);

  EditPage = (function(_super) {
    __extends(EditPage, _super);

    function EditPage() {
      _ref1 = EditPage.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    EditPage.prototype.init = function(type, inputData) {
      switch (type) {
        case "newComment":
          this.UI['new-comment-options'].J.show();
          break;
        default:
          this.UI['new-comment-options'].J.hide();
      }
      return CKEDITOR.instances.editPageEditor.setData(inputData);
    };

    return EditPage;

  })(RightSectionPage);

  SingleCommentPage = (function(_super) {
    __extends(SingleCommentPage, _super);

    function SingleCommentPage(target) {
      target.J.html(window.tpls['single-comment-item']);
      SingleCommentPage.__super__.constructor.call(this, target);
    }

    SingleCommentPage.prototype.init = function(commentData) {
      var d, item, _i;
      for (d = _i = 1; _i <= 5; d = ++_i) {
        item = new Suzaku.Widget(this.UI['single-reply-li-tpl'].J.html());
        item.appendTo(this.UI['reply-list']);
      }
      return null;
    };

    return SingleCommentPage;

  })(RightSectionPage);

  window.RightSection = (function(_super) {
    __extends(RightSection, _super);

    function RightSection(app) {
      RightSection.__super__.constructor.call(this, "#right-section");
      this.app = app;
      this.commentsItems = [];
      this.rightSectionPages = [];
      this.pageStack = [];
      this.init();
    }

    RightSection.prototype.init = function() {
      var self;
      this.commentPage = new RightSectionPage(this.UI['comment-page']);
      self = this;
      this.editPage = new EditPage(this.UI['edit-page']);
      this.singleCommentPage = new SingleCommentPage(this.UI['single-comment-page']);
      this.rightSectionPages = [this.commentPage, this.editPage, this.singleCommentPage];
      this.initComments();
      return this.goInto(this.commentPage);
    };

    RightSection.prototype.initComments = function() {
      var i, item, m, _i, _j, _len, _len1, _ref2, _ref3;
      _ref2 = this.commentsItems;
      for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
        i = _ref2[_i];
        i.remove();
      }
      this.commentsItems = [];
      _ref3 = this.app.marks;
      for (_j = 0, _len1 = _ref3.length; _j < _len1; _j++) {
        m = _ref3[_j];
        item = new CommentsItem(this, m.comments);
        item.markData = m;
        item.appendTo(this.UI['comments-wrapper']);
        this.commentsItems.push(item);
        this.UI['comments-wrapper'].J.css("padding-bottom", window.screen.height);
      }
      return this;
    };

    RightSection.prototype.scrollToMarkComments = function(markData, markWidget) {
      var ci, paddingTop, targetTop, _i, _len, _ref2,
        _this = this;
      paddingTop = 30;
      _ref2 = this.commentsItems;
      for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
        ci = _ref2[_i];
        if (ci.markData.markid === markData.markid) {
          ci.J.siblings().removeClass("focus");
          targetTop = ci.dom.offsetTop - paddingTop;
          this.commentPage.J.animate({
            scrollTop: targetTop
          }, "normal", "swing", function() {
            return ci.J.addClass("focus");
          });
          return true;
        }
      }
    };

    RightSection.prototype.resetStack = function() {
      var last;
      this.pageStack = [];
      last = null;
      return this;
    };

    RightSection.prototype.goInto = function(page) {
      var last;
      last = this.pageStack[this.pageStack.length - 1];
      if (last) {
        last.leaveToLeft();
      }
      this.pageStack.push(page);
      page.enterFromRight();
      return this;
    };

    RightSection.prototype.goBack = function() {
      var current;
      current = this.pageStack.pop();
      if (!current) {
        console.error("no page to go back");
        return false;
      }
      current.leaveToRight();
      this.pageStack[this.pageStack.length - 1].enterFromLeft();
      return this;
    };

    RightSection.prototype.showNewCommentHint = function() {
      var contentJ, hintJ,
        _this = this;
      hintJ = this.UI['new-comment-hint'].J;
      contentJ = hintJ.find(".content");
      hintJ.show();
      contentJ.slideDown("fast");
      return this.UI['new-comment-cancel-btn'].onclick = function() {
        _this.hideNewCommentHint();
        return _this.app.newCommentCanceled();
      };
    };

    RightSection.prototype.hideNewCommentHint = function() {
      var contentJ, hintJ,
        _this = this;
      hintJ = this.UI['new-comment-hint'].J;
      contentJ = hintJ.find(".content");
      return contentJ.slideUp("fast", function() {
        return hintJ.hide();
      });
    };

    RightSection.prototype.showEditPage = function(type, inputData, success, fail) {
      var _this = this;
      this.editPage.init(type, inputData);
      this.UI['edit-accept-btn'].onclick = function() {
        var content;
        content = CKEDITOR.instances.editPageEditor.getData();
        success(content);
        return _this.goBack();
      };
      this.UI['edit-cancel-btn'].onclick = function() {
        fail();
        return _this.goBack();
      };
      return this.goInto(this.editPage);
    };

    RightSection.prototype.showSingleComment = function(commentData) {
      var _this = this;
      this.singleCommentPage.init(commentData);
      this.singleCommentPage.UI['back'].onclick = function() {
        return _this.goBack();
      };
      return this.goInto(this.singleCommentPage);
    };

    return RightSection;

  })(Suzaku.Widget);

  CommentsItem = (function(_super) {
    __extends(CommentsItem, _super);

    function CommentsItem(rightSection, comments) {
      var c, first, _i, _len, _ref2,
        _this = this;
      CommentsItem.__super__.constructor.call(this, window.tpls['comments-item']);
      this.rightSection = rightSection;
      this.comments = comments;
      this.toggleItems = [];
      this.unfoldBtn = null;
      this.folded = true;
      if (this.comments.length > 3) {
        first = this.addItem(this.comments[0]);
        this.insertUnfoldBtn(first);
        this.addItem(this.comments[this.comments.length - 1]);
        this.UI['fold'].onclick = function() {
          return _this.fold();
        };
      } else {
        _ref2 = this.comments;
        for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
          c = _ref2[_i];
          this.addItem(c);
        }
      }
    }

    CommentsItem.prototype.fold = function() {
      var i, item, _i, _len, _ref2;
      if (this.folded) {
        return false;
      }
      this.UI['fold'].J.fadeOut("fast");
      this.unfoldBtn.J.fadeIn("fast");
      _ref2 = this.toggleItems;
      for (i = _i = 0, _len = _ref2.length; _i < _len; i = ++_i) {
        item = _ref2[i];
        item.remove();
        this.toggleItems[i] = null;
      }
      this.toggleItems = [];
      return this.folded = true;
    };

    CommentsItem.prototype.unfold = function() {
      var c, i, item, _i, _len, _ref2;
      if (!this.folded) {
        return false;
      }
      this.UI['fold'].J.fadeIn("fast");
      this.unfoldBtn.J.hide();
      _ref2 = this.comments;
      for (i = _i = 0, _len = _ref2.length; _i < _len; i = ++_i) {
        c = _ref2[i];
        if (!(i > 0 && i < (this.comments.length - 1))) {
          continue;
        }
        item = this.addItem(c, true);
        this.toggleItems.push(item);
      }
      return this.folded = false;
    };

    CommentsItem.prototype.addItem = function(data, animate) {
      var item,
        _this = this;
      if (animate == null) {
        animate = false;
      }
      item = new Suzaku.Widget(this.UI['single-comment-li-tpl'].J.html());
      item.data = data;
      item.UI.content.J.html(data.content);
      item.UI.nickname.J.text(data.nickname);
      item.UI['reply-num'].J.text(data.replynum);
      item.UI['vote-up-num'].J.text(data.praisenum);
      item.dom.onclick = function() {
        return _this.rightSection.showSingleComment(item.data);
      };
      item.appendTo(this.UI.list);
      return item;
    };

    CommentsItem.prototype.insertUnfoldBtn = function(target) {
      var item,
        _this = this;
      item = new Suzaku.Widget(this.UI['unfold-btn-tpl'].J.html());
      item.dom.onclick = function() {
        return _this.unfold();
      };
      item.after(target);
      item.UI['num'].J.text(this.comments.length - 2);
      return this.unfoldBtn = item;
    };

    return CommentsItem;

  })(Suzaku.Widget);

}).call(this);
